<link rel="import" href="/public/bower_components/polymer/polymer.html">

<link rel="import" href="/public/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/public/bower_components/iron-list/iron-list.html">

<link rel="import" href="/public/bower_components/paper-material/paper-material.html">
<link rel="import" href="/public/bower_components/paper-toggle-button/paper-toggle-button.html">

<dom-module id="post-list">

    <style>
        paper-material {
        	margin: 16px 16px 0 16px;
        	padding: 20px;
        }

        paper-toggle-button.publish {
        	--paper-toggle-button-checked-bar-color: rgba(63, 81, 181, 0.9);
        	--paper-toggle-button-checked-button-color: #3F51B5;
        	--paper-toggle-button-checked-ink-color: --dark-primary-color;
        	--paper-toggle-button-unchecked-ink-color: rgba(63, 81, 181, 0.7);
        }

        .actions {
        	font-size: 1.2em;
        	list-style: none;
        	margin: 0;
        	padding: 0;
        }

        .actions .title {
        	font-weight: bold;
        	padding-left: 50px;
        }

        .actions li {
        	margin: 15px 0;
        	text-align: left;
        	width: 160px;
        }

        .actions a {
        	color: black;
        	text-decoration: none;
        }

        .action-publish:hover {
        	cursor: pointer;
        }

        .action-icon, .action-text {
        	display: inline-block;
        }

        .action-icon {
        	text-align: center;
        	width: 48px;
        	height: 20px;
        }

        .post-card {
        	display: flex;
        	display: -webkit-flex;
        	justify-content: space-around;
        	-webkit-justify-content: space-around;
        	align-content: center;
        	-webkit-align-content: center;
        	align-items: flex-start;
        	-webkit-align-items: flex-start;
        	height: 192px;
        }

        .post-info {
        	display: flex;
        	display: -webkit-flex;

        	flex-direction: column;
        	-webkit-flex-direction: column;

        	justify-content: space-between;
        	-webkit-justify-content: space-between;

        	height: 100%;
        	text-align: center;
        }

        .post-time {
        	font-size: 1.5em;
        	font-weight: bold;
        }

        .post-content {
        	width: 75%;
        	height: 100%;
        	display: flex;
        	display: -webkit-flex;
        	flex-direction: column;
        	-webkit-flex-direction: column;
        	align-items: center;
        	-webkit-align-items: center;
        	justify-content: space-between;
        	-webkit-justify-content: space-between;
        }

        .post-content h3 {
        	font-size: 1.5em;
        }

        .post-content p {
        	color: rgba(128, 128, 128, 0.85);
        	line-height: 1.75em;
        	min-height: 95px;
        }
    </style>

	<template>
		<iron-ajax url="{{dataLink}}" last-response={{data}} auto on-response="handleAJAX"></iron-ajax>

		<template is="dom-if" if="{{ noPost }}">
		    <p>{{emptyMessage}}</p>
		</template>

		<iron-list items="[[data]]" as="item">
			<template>
			    <div class="item">
					<paper-material elevation="1" class="post-card">
						<aside class="post-info">
							<span class="post-time">[[getDateDOM(item.CreatedAt)]]</span>

							<ul class="actions">
							    <li class="title">Post Actions</li>
								<li class="action-publish">
									<a href="[[item.ToggleLink]]" on-click="publishClicked">
										<span class="action-icon">
										    <paper-toggle-button id="{{ getToggleButtonID(item) }}" class="publish" checked="{{ checkPublished(item) }}" on-change="toggleClicked"></paper-toggle-button>
									    </span>

									    <span class="action-text" id="{{ getPublishTextID(item) }}">
									    	<template is="dom-if" if="{{ checkPublished(item) }}">
									    	Unpublish
									    	</template>

									    	<template is="dom-if" if="{{ !checkPublished(item) }}">
									    	Publish
									    	</template>
									    </span>
								    </a>
							    </li>

							    <li>
							    	<a href="[[item.EditLink]]">
							    		<span class="action-icon">
									    	<iron-icon icon="editor:mode-edit"></iron-icon>
								    	</span>

								    	<span class="action-text">
									    	Edit
								    	</span>
							    	</a>
							    </li>
						    </ul>
						</aside>

						<article class="post-content">
						    <h3>[[item.Title]]</h3>
						    <p>[[getFirstParagraph(item.Content)]]</p>
						</article>
					</paper-material>
				</div>
			</template>
		</iron-list>
	</template>

	<script>
	var MonthNames = [
	    "Jan", "Feb", "Mar", "Apr", "May", "Jun", 
	    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
	];

	Polymer({
		is: "post-list",
		properties: {
			dataLink: String,
			emptyMessage: String
		},
		handleAJAX: function (request) {
			var postCount = request.detail.parseResponse().length;

			this.noPost = postCount === 0;
		},
		publishClicked: function (e) {
			e.preventDefault();

			var that = this;
			$.ajax({
				url         : e.target.closest('a').getAttribute('href'),
				type        : "GET",
				success     : function (data, textStatus, jqXHR) {
					var id = jqXHR.responseJSON["id"];

					var toggle = that.$$("#" + that.getToggleButtonID({'ID':id}));
					toggle.checked = !toggle.checked;

					var publishText = that.$$("#" + that.getPublishTextID({'ID':id}));
					publishText.textContent = that.getPublishText(toggle.checked);

					var notif = that.createNotification("Post successfully updated!", 5000, false);

					setTimeout(function () {
						notif.show();
					}, 500);
				}
			});
		},
		toggleClicked: function (e) {
			e.target.checked = !e.target.checked;
		},
		getToggleButtonID: function (item) {
			return "toggle-button-" + item.ID;
		},
		getPublishTextID: function (item) {
			return "publish-text-" + item.ID;
		},
		getPublishText: function (status) {
			return (status)? "Unpublish": "Publish";
		},
		getFirstParagraph: function (content) {
			var div = document.createElement("div");
			div.innerHTML = content;

			return div.firstChild.textContent;
		},
		checkPublished: function (item) {
			return item.Published === true;
		},
		getDateDOM: function (date) {
			var jsDate = this.RFC3339ToDate(date),
			    result = jsDate.getDate()  + " " +
			             MonthNames[jsDate.getMonth()] + " " + 
			             jsDate.getFullYear();

			return result;
		},
		// because golang's default time.Time format
		// is on RFC3339
		RFC3339ToDate: function (date) {
			var epoch = Date.parse(date);

			return new Date(epoch);
		},
		createNotification: function (text, duration, isError) {
	    	var notif = document.createElement("paper-toast");
	    	var label = document.createElement("span");
	    	var parentElement = document.querySelector("#flash-container");

	    	notif.setAttribute("duration", duration);

	        if (isError) {
	        	notif.classList.add("error");
	        }

	    	label.setAttribute("id", "label");
	    	label.classList.add("style-scope");
	    	label.classList.add("paper-toast");

	    	label.textContent = text;

	    	notif.appendChild(label);
	    	parentElement.appendChild(notif);

	    	return notif;
		}
	});
	</script>
</dom-module>